pipeline {
    agent any

    environment {
        MVN_HOME = tool 'maven-3.5.2'
    }

    stages {
        stage('Build and Test') {
            steps {
                script {
                    // Utilisation de la variable d'environnement WORKSPACE pour obtenir le chemin complet du répertoire de travail
                    def projectPath = "${WORKSPACE}/demo"
                    sh "${MVN_HOME}/bin/mvn -f ${projectPath}/pom.xml clean test"
                }
            }
        }

        stage('Modify and Fail Test') {
            steps {
                script {
                    def projectPath = "${WORKSPACE}/demo"
                    // Modifier intentionnellement le test pour le faire échouer
                    sh "sed -i 's/assertEquals(3, Calculator.add(1, 2))/assertEquals(4, Calculator.add(1, 2))/' ${projectPath}/src/test/java/com/example/demo/CalculatorTest.java"
                }
            }
        }

        stage('Verify Compilation and Failing Test') {
            steps {
                script {
                    def projectPath = "${WORKSPACE}/demo"
                    // Vérifier que la compilation fonctionne et que le test échoue
                    sh "${MVN_HOME}/bin/mvn -f ${projectPath}/pom.xml clean test"
                }
            }
        }

        stage('Ignore Test') {
            steps {
                script {
                    def projectPath = "${WORKSPACE}/demo"
                    // Ignorer le test temporairement
                    sh "sed -i '/@Test/,/@Ignore/ s/^/\\/\\/ /' ${projectPath}/src/test/java/com/example/demo/CalculatorTest.java"
                }
            }
        }

        stage('Verify Ignored Test') {
            steps {
                script {
                    def projectPath = "${WORKSPACE}/demo"
                    // Vérifier que la compilation fonctionne avec le test ignoré
                    sh "${MVN_HOME}/bin/mvn -f ${projectPath}/pom.xml clean test"
                }
            }
        }

        stage('Publish Test Reports') {
            steps {
                // Dépend du plugin utilisé pour la génération des rapports
                // Exemple avec le plugin JUnit
                junit '${projectPath}/target/surefire-reports/*.xml'
            }
        }
    }
}
