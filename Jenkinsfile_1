pipeline {
    agent any

    environment {
        MVN_HOME = tool 'maven-3.5.2'
    }

    stages {
        stage('Clone repo') {
            steps {
                checkout scm
            }
        }

        stage('Build and Test') {
            steps {
                dir('demo') {
                    script {
                        sh "${MVN_HOME}/bin/mvn clean test"
                    }
                }
            }
        }

        stage('Modify Test to Fail') {
            steps {
                dir('demo') {
                    script {
                        // Modifier un test pour le faire échouer
                        // Vous pouvez ajouter ici le code pour modifier le test
                    }
                }
            }
        }

        stage('Build with Failing Test') {
            steps {
                dir('demo') {
                    script {
                        // Assurez-vous que la compilation fonctionne malgré l'échec du test
                        sh "${MVN_HOME}/bin/mvn clean package"
                    }
                }
            }
        }

        stage('Ignore Test') {
            steps {
                dir('demo') {
                    script {
                        // Ignorer le test pour obtenir un build correct
                        sh "${MVN_HOME}/bin/mvn clean package -DskipTests"
                    }
                }
            }
        }

        stage('Publish Test Report') {
            steps {
                // Ajouter ici les étapes pour publier le rapport de tests
                junit 'target/surefire-reports/*.xml'
            }
        }

        stage('Generate Javadoc') {
            steps {
                dir('demo') {
                    script {
                        sh "${MVN_HOME}/bin/mvn javadoc:javadoc"
                        sh 'ls -l target/site'
                    }
                }
            }
        }

        stage('Archive Javadoc') {
            steps {
                archiveArtifacts artifacts: 'demo/target/site/apidocs/**/*', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo 'This will always run'
        }
        success {
            echo 'This will run only if the build is successful'
        }
        failure {
            echo 'This will run only if the build fails'
        }
    }
}
