pipeline {
    agent any

    environment {
        MVN_HOME = tool 'maven-3.5.2'
    }

    stages {
        stage('Print Maven Version') {
            steps {
                script {
                    sh '${MVN_HOME}/bin/mvn --version'
                }
            }
        }

        stage('Build and Test') {
            steps {
                script {
                    // Utilisez le chemin complet de l'exécutable Maven
                    sh '${MVN_HOME}/bin/mvn clean test'
                }
            }
        }

        stage('Modify and Fail Test') {
            steps {
                script {
                    // Modifier intentionnellement le test pour le faire échouer
                    sh "sed -i 's/assertEquals(Integer.valueOf(5), Calculator.add(2, 3))/assertEquals(Integer.valueOf(6), Calculator.add(2, 3))/' src/test/java/CalculatorTest.java"
                }
            }
        }

        stage('Verify Compilation and Failing Test') {
            steps {
                script {
                    // Vérifier que la compilation fonctionne et que le test échoue
                    sh '${MVN_HOME}/bin/mvn clean test'
                }
            }
        }

        stage('Ignore Test') {
            steps {
                script {
                    // Ignorer le test temporairement
                    sh "sed -i '/@Test/,/@Ignore/ s/^/\\/\\/ /' src/test/java/CalculatorTest.java"
                }
            }
        }

        stage('Verify Ignored Test') {
            steps {
                script {
                    // Vérifier que la compilation fonctionne avec le test ignoré
                    sh '${MVN_HOME}/bin/mvn clean test'
                }
            }
        }

        stage('Publish Test Reports') {
            steps {
                // Dépend du plugin utilisé pour la génération des rapports
                // Exemple avec le plugin JUnit
                junit '**/target/surefire-reports/*.xml'
            }
        }
    }
}
