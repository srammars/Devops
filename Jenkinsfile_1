pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout your Git repository
                    checkout scm
                }
            }
        }

        stage('Build and Test') {
            steps {
                script {
                    // Build and run tests with Maven
                    sh 'mvn clean test'
                }
            }
        }

        stage('Modify Test to Fail') {
            steps {
                script {
                    // Simulate a failing test
                    sh 'echo "public class CalculatorTest { @Test public void failingTest() { assert false } }" > src/test/java/CalculatorTest.java'
                }
            }
        }

        stage('Build with Failing Test') {
            steps {
                script {
                    // Build and run tests with Maven (expecting a failure)
                    sh 'mvn clean test'
                }
            }
        }

        stage('Ignore Test') {
            steps {
                script {
                    // Ignore the failing test via Maven Surefire Plugin configuration
                    sh 'echo "<properties><maven.test.skip>true</maven.test.skip></properties>" > pom.xml'
                }
            }
        }

        stage('Publish Test Report') {
            steps {
                script {
                    // Assuming your test reports are generated in the target/surefire-reports directory
                    junit 'target/surefire-reports/**/*.xml'
                }
            }
        }
    }

    post {
        always {
            // Clean up and restore original state
            script {
                sh 'mvn clean'
                sh 'git checkout -- src/test/java/CalculatorTest.java pom.xml'
            }
        }
    }
}
