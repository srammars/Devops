pipeline {
    agent any
    
    tools {
        // Spécifiez ici la version de Maven à utiliser
        maven 'maven-3.5.2'
    }
    
    stages {
        stage('Build and Test') {
            steps {
                script {
                    // Étape 1: Vérifier que la compilation et les tests sont passants
                    sh 'mvn clean compile test'
                }
            }
        }

        stage('Modify Test to Fail') {
            steps {
                script {
                    // Étape 2: Modifier un test de manière à la faire échouer
                    sh 'sed -i "s/assertEquals(5, calculatrice.add(2, 3));/assertEquals(6, calculatrice.add(2, 3));/" src/test/java/CalculatriceTest.java'
                    sh 'mvn test'
                }
            }
        }

        stage('Check Compilation and Test Status') {
            steps {
                script {
                    // Étape 3: Vérifier que la compilation fonctionne et que le test remonte en KO
                    catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
                        sh 'mvn test'
                    }
                }
            }
        }

        stage('Ignore Test') {
            steps {
                script {
                    // Étape 4: Ignorer le test via Maven de façon à obtenir un build correct
                    sh 'echo "@Disabled" >> src/test/java/CalculatriceTest.java'
                    sh 'mvn test'
                }
            }
        }

        stage('Publish Test Reports') {
            steps {
                script {
                    // Étape 5: Publier le rapport de tests
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
    }
}
